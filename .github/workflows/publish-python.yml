name: Publish Python Package to PyPI

on:
  workflow_dispatch:
    inputs:
      version:
        description: '要发布的版本号（格式：1.2.3）'
        required: true
        type: string
        default: '1.0.0'

jobs:
  build:
    name: Build Python Package
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
        architecture: [x64, arm64]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Update version in pyproject.toml
      working-directory: tmp/lib_um_crypto_rust/um_python
      run: |
        VERSION="${{ github.event.inputs.version }}"
        echo "Updating version to: $VERSION"
        
        # 使用sed命令更新pyproject.toml中的版本号
        sed -i.bak 's/version = ".*"/version = "'"$VERSION"'"/' pyproject.toml
        
        # 验证版本号更新
        echo "Updated pyproject.toml version section:"
        grep "version = " pyproject.toml

    - name: Install maturin
      run: pip install maturin

    - name: Build Python package
      working-directory: tmp/lib_um_crypto_rust/um_python
      run: |
        # 启用ABI3向前兼容性
        export PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1
        
        echo "Building for ${{ matrix.os }} ${{ matrix.architecture }} architecture"
        
        # 验证pyproject.toml版本号
        echo "Current pyproject.toml version:"
        grep "version = " pyproject.toml
        
        # 根据架构设置目标平台
        if [ "${{ matrix.architecture }}" = "arm64" ]; then
          echo "Building for ARM64 architecture"
          maturin build --release --interpreter python --target aarch64-unknown-linux-gnu
        else
          echo "Building for x64 architecture"
          maturin build --release --interpreter python
        fi
        
        echo "Built wheel files:"
        ls -la ../target/wheels/

    - name: Upload wheels as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}-${{ matrix.architecture }}-py${{ matrix.python-version }}
        path: tmp/lib_um_crypto_rust/target/wheels/*.whl
        retention-days: 7

  publish:
    name: Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate version format
      run: |
        VERSION="${{ github.event.inputs.version }}"
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "错误：版本号格式不正确，请使用 X.Y.Z 格式（例如：1.0.0）"
          exit 1
        fi
        echo "版本号验证通过: $VERSION"

    - name: Download all wheels
      uses: actions/download-artifact@v4
      with:
        pattern: wheels-*
        path: dist

    - name: Combine all wheels
      run: |
        mkdir -p combined_dist
        find dist -name "*.whl" -exec cp {} combined_dist/ \;
        echo "Combined wheel files:"
        ls -la combined_dist/

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"

    - name: Install twine
      run: pip install twine

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "发布版本: ${{ github.event.inputs.version }}"
        twine upload combined_dist/*.whl
        echo "✅ 发布完成！版本 ${{ github.event.inputs.version }} 已成功发布到 PyPI"